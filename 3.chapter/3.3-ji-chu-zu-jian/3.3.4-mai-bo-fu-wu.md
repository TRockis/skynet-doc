# 3.3.4 脉搏服务

## 1. 组件功能

服务节点之间的状态订阅同步。应用场景如 状态路由服务



## 2. 组件说明

Maven 起步依赖坐标：

```markup
<dependency>
    <groupId>com.iflytek.skynet</groupId>
    <artifactId>skynet-cloud-throb-parent</artifactId>
</dependency>
```

主要组件：ThrobServer 和 ThrobClient

* ThrobServer：脉搏服务 服务端，主要是开启服务侦听。
* ThrobClient：脉搏服务 客户端，订阅服务端状态变化。

{% tabs %}
{% tab title="ThrobServer" %}
```java
/**
 * 脉搏服务
 * 
 * @author lyhu [2016年10月28日下午2:08:27]
 */
public interface ThrobServer extends AutoCloseable {

	/**
	 * 启动 
	 * <pre>
	 * 当前Action
	 * </pre>
	 * @param port
	 *            如果为0，端口将随机
	 * @param fetcher
	 * @throws RpcException
	 */
	public void start(int port, ThrobStateFetcher<?> fetcher) throws RpcException;

	/**
	 * 启动
	 * 
	 * @param port
	 *            如果为0，端口将随机
	 * @param targetActionName
	 * @param fetcher
	 * @throws RpcException
	 */
	public void start(int port, String targetActionName, ThrobStateFetcher<?> fetcher) throws RpcException;

	/**
	 * 主动更新状态，通知客户端
	 *  
	 * @param state
	 */
	public void update(Object state);

	/**
	 * @return the actionName
	 */
	public String getActionName();

	/**
	 * ThrobServer 对外访问地址
	 *  
	 * @return
	 * @throws RpcException
	 */
	public String getEndpoint() throws RpcException;
}
```
{% endtab %}

{% tab title="ThrobClient" %}
```java
/**
 * 
 * 脉搏客户端
 * 
 * <pre>
 * 处理思路：
 * 从ZK中获取相应服务的脉搏endpoint，订阅每个实际会话服务内部状态。
 * </pre>
 * 
 * @author lyhu [2016年10月31日上午11:12:33]
 *
 */
public interface ThrobClient extends AutoCloseable {

	/**
	 * 连接 ThrobServer
	 * 
	 * @param actionName
	 * @param timeout
	 *            超时时间，单位毫秒
	 * @param throbStateObserver
	 *            状态观察者
	 */
	public void connect(final String actionName, final int timeout, ThrobStateObserver throbStateObserver);

	/**
	 * 获取Action名称
	 * 
	 * 
	 * @return
	 */
	public String getActionName();

	/**
	 * 主动获取ThrobState
	 * 
	 * @return
	 * @throws RpcException
	 */
	public Collection<ThrobState> getStateList() throws RpcException;

	/**
	 * 随机获取一个状态
	 * 
	 * <pre>
	 * </pre>
	 * 
	 * @return
	 * @throws RpcException
	 */
	public ThrobState getState() throws RpcException;
}

```
{% endtab %}

{% tab title="ThrobStateFetcher" %}
```text

/**
 * 脉搏状态获取器
 *
 * @author lyhu [2016年10月28日下午2:09:00]
 *
 * @param <T>
 *            脉搏状态类型
 */
public interface ThrobStateFetcher<T> {
	T fetch();
}
```
{% endtab %}

{% tab title="ThrobStateObserver" %}
```java

/**
 * 脉搏状态 变化订阅器
 * 
 * @author lyhu
 *
 */
public interface ThrobStateObserver {

	void update(Collection<ThrobState> throbStates);
}
```
{% endtab %}
{% endtabs %}



## 3. 调用示例

## 4. 实现原理

客户端主动获取服务端的状态 和 服务端内部状态变化主动推送到所有的客户端。

服务间通信采用  WebSocket 订阅与通知。

实现过程如下：



## 5. 注意事项

