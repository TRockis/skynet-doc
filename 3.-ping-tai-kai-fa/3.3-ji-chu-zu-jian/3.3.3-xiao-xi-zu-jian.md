# 3.3.3 消息组件

## 1. 组件功能

 Mq消息的发送服务类，可以使用这个服务把mq消息发送到指定队列，可以使用spring的@Autowired注解引用，调用getProducer方法可以获取IMqProducer，有了IMqProducer对象就可以发送mq消息了

## 2. 组件说明

MQ消息服务分为生产者以及消费者，主要是以下三个类：

* MqActionProducer：消息生产者管理器
* MqActionConsumer：消息消费者组件
* OnlineMqManager：在线MQ管理器

## 3. 调用示例

 下面是消息发送测试代码

```java
 public class MqActionProducerTest {
 
    @Autowired
	private MqActionProducer mqActionProducer;

	//获取producer，发送message
	@Test
	public final void testGetProducer() throws Exception {
		StopWatch stopWatch = new StopWatch();
		MqParam MqParam = new MqParam();
		MqParam.mqUri = "tcp://192.168.84.190:61616";
		MqParam.outq = "mq_test";
		String trackId = "abc";
		MqParam.mqType = MqType.amq;

		MqMessage message = new MqMessage();
		message.setPriority(9);
		message.setBody(
				"{'id':'BaIjzJd73lMdWPXyS8tju23BkV','audio':{'aid':'U8pCY52ejHIIpY4uAqig0LpNdO','bits':16,'chnl':1,'encoding':1,'offset':0,'rate':8000,'spkn':1,'uri':'http://192.168.84.190:46029/U8pCY52ejHIIpY4uAqig0LpNdO_wav.bin'},'resId':0,'type':2,'tags':{}}");

		stopWatch.start();

		for (int i = 0; i < 100; i++) {
			mqActionProducer.getProducer(MqParam).send(trackId, message);
		}
		System.out.println(stopWatch);
		mqActionProducer.close();

		System.out.println("==ok=====");
	}
}
```

下面是消息消费代码，其中“**mq-test-v2.0@engine**”是按照我们skynet规范封装的一个mq服务

```java
public class MqActionConsumerTest {

	@Autowired
	private MqActionConsumer mqActionConsumer;

	//获取consumer，对消息进行监听消费
	@Test
	public final void testListen() throws Exception {

		MqParam mqParam = new MqParam();
		mqParam.mqUri = "tcp://192.168.59.15:61616";
		mqParam.inq = "mq-test";
		mqParam.mqType = MqType.amq;

		mqActionConsumer.listen("mq-test-v2.0@engine", mqParam, null);

		System.out.println("==wait ====");
		Thread.sleep(100000000);
		mqActionConsumer.close();
		System.out.println("==ok=====");
	}
}

```

实现此类mq服务，action需要实现服务上下接口（ MqSvcContext）和mq服务消息处理器（MqSvcHandler），下面是MqSvcContext接口实现示例

```java
@Component(VsppActionContext.SVC_NAME + ".context")
public class VsppActionContext implements MqSvcContext {

	public static final String SVC_NAME = "mq-test-v2.0@engine";

	@Override
	public String getSvcName() {
		return SVC_NAME;
	}

	@Override
	public void init(Map<String, Object> params) {
	    //进行引擎的初始化加载工作
	}

	@Override
	public Map<String, Object> getSvcState() throws Exception{
		return null;
	}

	@Override
	public void close() throws Exception {

	}
```

下面是MqSvcHandler接口实现示例

```java
@Scope("prototype")
@Component(VsppActionContext.SVC_NAME + ".handler")
public class VsppActionHandler extends MqSvcHandler<VsppActionContext, PVsppParam, PVsppResult> {

	@Override
	protected void onInit(VsppActionContext mqSvcCtx) throws Exception {
	
	}

	@Override
	protected ActionResponse<PVsppResult> onProcess(String trackId, ActionRequest<PVsppParam> request, VsppActionContext mqSvcCtx) {
	    //这里要进行消息的获取与入队处理
		ActionResponse<PVsppResult> response = new ActionResponse<PVsppResult>(request.getBizId());
		return response;
	}

	@Override
	protected void onClose() throws Exception {
	}
}
```

## 4. 实现原理

## 5. 注意事项

