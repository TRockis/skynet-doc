# 3.5.4 流式计算服务

## 1. 流程服务相关概念

 在使用skynet的流程服务时，需要先了解以下的概念

* 流程节点：skynet的流程节点，都是mq服务。流程启动时，会向该mq服务注册出队与入队信息
* 节点拦截器：类似于spring的切面，设置该节点之前和之后的处理
* 流程分支选择器：节点和节点流转时的条件选择，根据条件，选择要流向的节点
* 参数构造器：节点流转到下一个节点时，参数转换的方法类
* 流程构建器：构建流程需要实现的接口，主要是实现流程名称获取与流程构建方法
* 流程启动器：注册mq监听，启动流程

## 2. 相关概念详解

### 2.1 **流程中的节点ActivityNode**

 ActivityNode具体的服务（处理mq消息）节点是mq服务类型的action，引擎服务相关的action在引擎服务中都写好了，只要根据对应的输入输出参数进行使用就可以了。下面是一个vspp节点定义示例：

```java
public class VsppActivityNode extends ActivityNode<PVsppParam, PVsppResult> {

	public VsppActivityNode(String name, String actionName) {
		super(name, actionName);
	}
}
```

### 2.2 **节点拦截器ActionModule**

 ActionModule可以对ActivityNode节点消息进行拦截并处理，也可以根据返回值控制流程是否提前结束。下面是ActionModule的使用示例：

```java
istNode4Chin.setActionModule(new ActionModule<PIstParam, PIstResult>() {
    //重写处理前执行事件
	@Override
	protected boolean onBefore(ProcContext<PIstParam, PIstResult> procContext, MqSvcContext mqSvcContext) throws Exception {
		return super.onBefore(procContext, mqSvcContext);
			}
		
	//重写处理后执行事件	
	@Override
	protected boolean onAfter(ProcContext<PIstParam, PIstResult> procContext, MqSvcContext mqSvcContext) throws Exception {
		return super.onAfter(procContext, mqSvcContext);
			}
		});
```

 重写这两个方法，方法作用分别是：   
1、onBefore\(\):ActionHandler 处理前执行事件，返回false将不进行处理   
2、onAfter\(\):ActionHandler 处理后执行事件，返回false将不进行处理

 **引擎服务节点不建议使用拦截器，拦截器和所属节点是在同一个jvm里面的，如果要在本地调试需要把引擎资源放到本地，需要起引擎（资源消耗很大）**

### 2.3 **流程分支选择器ActionChooser**

 此类主要用于流程分支的判断根据当前节点的输入输出以及上下文参数判断是不是要流转到下一个节点，使用时直接继承下面的类。下面是ActionChooser的使用示例：

```java
vsppNode.trans(istNode4Chin, istParamBuilder, new ActionChooser<PVsppParam, PVsppResult>() {
        //重写onChoose方法，选择下一流入节点
		@Override
		protected boolean onChoose(ProcContext<PVsppParam, PVsppResult> procContext, MqSvcContext mqSvcContext) {
			return VsppActionHandler.LAN_CHIN.equals(procContext.getActionReponse().getBody().getLan());
			}
		});
```

### 2.4 流程节点参数构建器ActionParamBuilder

此类主要作用是在节点流转的过程中，当前节点的输出参数跟要流转节点的输入参数类型不匹配，使用这个类进行参数的转换，实用时直接集成下面的类。下面是使用示例：

```java
ActionParamBuilder<String, ImportParam, PVsppParam> vsppParamBuilder = new ActionParamBuilder<String, ImportParam, PVsppParam>() {

        //重写参数转换方法
		@Override
		protected ActionRequest<PVsppParam> onBuild(ProcContext<String, ImportParam> procContext, MqSvcContext mqSvcContext) {

		ImportParam importParam = procContext.getActionReponse().getBody();

		PVsppParam pVsppParam = JSON.parseObject(importParam.toJson(), PVsppParam.class);
				pVsppParam.setAudioUrl(importParam.getAudioUrl());

		return new ActionRequest<PVsppParam>(pVsppParam);
			}
		};
```



